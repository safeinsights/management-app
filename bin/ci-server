#!/bin/sh

set -e

export ASSETS_PREFIX=/
export PORT=4000
export NEXT_PUBLIC_CLERK_DOMAIN=localhost:4000
export HOSTNAME=0.0.0.0
export CODER_FILES=./coder-files

LOG=$1

if [ -z "$LOG" ]; then
    echo "Usage: $0 <logfile>"
    exit 1
fi

npm run build > $LOG 2>&1

cp -r public .next/standalone/
mkdir -p .next/standalone/coder-files
cp tests/coder-files/main.r tests/coder-files/main.py tests/coder-files/code.r .next/standalone/coder-files/
cp -r .next/static .next/standalone/.next/

node .next/standalone/server.js >> $LOG 2>&1 &
SERVER_PID=$!

echo "starting in background with pid $SERVER_PID"
echo "process name will be: next-server"

echo "waiting for server to be reachable..."
for i in $(seq 1 3); do
    if curl -s -o /dev/null -w "%{http_code}" http://localhost:4000/ 2>/dev/null | grep -q '^[23]'; then
        echo "server is reachable on localhost:4000 (attempt $i)"
        break
    fi
    if curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:4000/ 2>/dev/null | grep -q '^[23]'; then
        echo "server is reachable on 127.0.0.1:4000 (attempt $i)"
        break
    fi
    if [ $i -eq 3 ]; then
        echo "ERROR: server not reachable after 3 attempts"
        echo "--- netstat ---"
        ss -tlnp | grep 4000 || true
        echo "--- curl localhost ---"
        curl -v http://localhost:4000/ 2>&1 || true
        echo "--- curl 127.0.0.1 ---"
        curl -v http://127.0.0.1:4000/ 2>&1 || true
        echo "--- server log ---"
        tail -20 $LOG || true
        exit 1
    fi
    sleep 2
done
