#!/bin/bash

set -e

TYPES=src/database/types.ts

npx kysely migrate:latest

npx kysely-codegen \
  --camel-case \
  --dialect postgres \
  --out-file $TYPES \
  --overrides='{"columns":{"org_code_env.settings":"Generated<OrgCodeEnvSettings>"}}' \
  --custom-imports='{"OrgCodeEnvSettings":"./types-manual#OrgCodeEnvSettings"}'

# run seeds after generating types above so the seed files see the updated DB state
npx kysely seed:run

# Add manual type import (kysely-codegen always regenerates the file, so this must run every time)
# inspiration from https://github.com/RobinBlomberg/kysely-codegen/issues/273
# kysely-codegen ovverides and custom-imports used above seem ineffectual even
# though tho https://github.com/RobinBlomberg/kysely-codegen/pull/274 should have added it
awk '/import type { ColumnType } from "kysely"/ {print; print "import type { OrgCodeEnvSettings } from \"./types-manual\";"; next}1' $TYPES > ${TYPES}.tmp
mv ${TYPES}.tmp $TYPES

# Add FileType alias for backwards compatibility with the renamed study_job_file_type enum
if ! grep -q "export type FileType" $TYPES; then
  echo "" >> $TYPES
  echo "export type FileType = StudyJobFileType" >> $TYPES
fi

# Re-export manual types at the end of the file for convenience
if ! grep -q "export type { EnvVar" $TYPES; then
  echo "" >> $TYPES
  echo "// Re-export manual types for convenience" >> $TYPES
  echo "export type { EnvVar, OrgCodeEnvSettings } from './types-manual'" >> $TYPES
fi

npx prettier --write $TYPES
npx eslint --fix $TYPES

npx tsx bin/seed-environment.ts

if [ -e "$CI" ]; then
    if git diff --name-only | grep -q 'src/database/types.ts'; then
        echo "src/database/types.ts has uncommitted changes."
        git diff 'src/database/types.ts'
        exit 1
    fi
fi
